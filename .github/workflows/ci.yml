name: CI

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch: {}
  push:
    branches: [ main, mster ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v2

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: |
          flake8 hello_world || true

  build:
    needs: [security-scan, code-quality]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image owner (lowercase)
        run: |
          OWNER=${{ github.repository_owner }}
          LOWER_OWNER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          printf "IMAGE_OWNER=%s\n" "$LOWER_OWNER" >> $GITHUB_ENV

      - name: Debug image owner and tags
        run: |
          echo "IMAGE_OWNER=$IMAGE_OWNER"
          echo "TAG1=ghcr.io/$IMAGE_OWNER/fordigitaocean-hello:$GITHUB_SHA"
          echo "TAG2=ghcr.io/$IMAGE_OWNER/fordigitaocean-hello:latest"

      - name: Build and push Docker image to GHCR
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file hello_world/Dockerfile \
            --push \
            --tag ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${GITHUB_SHA} \
            --tag ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:latest \
            hello_world
        env:
          DOCKER_BUILDKIT: 1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f hello_world/requirements.txt ]; then pip install -r hello_world/requirements.txt; fi

      - name: Run hello script
        working-directory: hello_world
        run: python hello.py

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            set -e
            # install docker if missing
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              curl -fsSL https://get.docker.com | sh
            fi

            # install compose plugin if missing
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            APP_DIR=/opt/ForDigitaOcean
            if [ -d "$APP_DIR" ]; then
              cd "$APP_DIR"
              git fetch --all
              git reset --hard origin/main
            else
              git clone https://github.com/Gubbya/ForDigitaOcean.git "$APP_DIR"
              cd "$APP_DIR"
            fi

            # login to GHCR if provided
            if [ -n "${GHCR_PAT}" ]; then
              echo "${GHCR_PAT}" | docker login ghcr.io -u Gubbya --password-stdin
            fi

            docker compose pull || true
            docker compose up -d --build
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/mster' || github.ref == 'refs/heads/staging'
    steps:
      - name: Deploy to Staging Droplet via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            set -e
            # install docker if missing
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              curl -fsSL https://get.docker.com | sh
            fi

            # install compose plugin if missing
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            APP_DIR=/opt/ForDigitaOcean
            if [ -d "$APP_DIR" ]; then
              cd "$APP_DIR"
              git fetch --all
              # checkout the staging branch if present
              git checkout -f mster || git checkout -f staging || true
              git reset --hard origin/mster || git reset --hard origin/staging || true
            else
              git clone https://github.com/Gubbya/ForDigitaOcean.git "$APP_DIR"
              cd "$APP_DIR"
              git checkout -f mster || git checkout -f staging || true
            fi

            # login to GHCR if provided
            if [ -n "${GHCR_PAT}" ]; then
              echo "${GHCR_PAT}" | docker login ghcr.io -u Gubbya --password-stdin
            fi

            docker compose pull || true
            docker compose up -d --build
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
