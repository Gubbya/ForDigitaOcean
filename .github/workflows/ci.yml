 # Symbols: ‚ùå ‚ö†Ô∏è ‚úÖ üö® üì∫ üìã ‚ÑπÔ∏è
name: CI CD Pipeline
permissions:
  contents: read
  packages: write

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master, staging ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL analysis
        run: |
          echo "Skipping CodeQL analysis: not used in this repo right now"

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: |
          flake8 hello_world || true

  build:
    needs: [security-scan, code-quality]
    outputs:
      version_tag: ${{ steps.meta.outputs.version_tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image owner (lowercase)
        run: |
          OWNER=${{ github.repository_owner }}
          LOWER_OWNER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          printf "IMAGE_OWNER=%s\n" "$LOWER_OWNER" >> $GITHUB_ENV

      - name: Debug image owner and tags
        run: |
          echo "IMAGE_OWNER=$IMAGE_OWNER"
          echo "TAG1=ghcr.io/$IMAGE_OWNER/fordigitaocean-hello:$GITHUB_SHA"
          echo "TAG2=ghcr.io/$IMAGE_OWNER/fordigitaocean-hello:latest"

      - name: "‚ú® Generate Version String & Tag"
        id: meta
        run: |
          set -e
          # VERSION_STRING: vYYYY.MM.DD-shortsha (matches reference)
          VERSION_STRING="v$(date -u +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          # Use IMAGE_OWNER (lowercased) set earlier to avoid invalid uppercase repo names
          VERSION_TAG="ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${VERSION_STRING}"
          echo "VERSION_STRING=${VERSION_STRING}" >> $GITHUB_ENV
          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
          # also set step output for job-level outputs
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Determine image tags (date + optional semantic)
        id: determine-tags
        run: |
          set -e
          DATE=$(date -u +%Y%m%d)
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          # always create a date-based tag for quick identification
          echo "TAG_DATE=ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${DATE}-${SHORT_SHA}" >> $GITHUB_ENV
          # also keep the SHA and latest tags
          echo "TAG_SHA=ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${GITHUB_SHA}" >> $GITHUB_ENV
          echo "TAG_LATEST=ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:latest" >> $GITHUB_ENV
          # if run triggered by a git tag, export semantic tag and semantic+date tag
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "TAG_SEM=ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${TAG_NAME}" >> $GITHUB_ENV
            echo "TAG_SEM_DATE=ghcr.io/${IMAGE_OWNER}/fordigitaocean-hello:${TAG_NAME}-${DATE}" >> $GITHUB_ENV
            echo "IS_TAG=1" >> $GITHUB_ENV
            echo "Detected tag: ${TAG_NAME}"
          else
            echo "IS_TAG=0" >> $GITHUB_ENV
          fi

      - name: "Build and push Docker image to GHCR (multi-tag: sha/latest/date/version)"
        run: |
          set -e
          # Buildx command with multiple tags: SHA, latest, date-based. Include semantic tags when present.
          BUILD_CMD=(docker buildx build --platform linux/amd64,linux/arm64 --file hello_world/Dockerfile --push)
          BUILD_CMD+=(--tag "${TAG_SHA}" --tag "${TAG_LATEST}" --tag "${VERSION_TAG}" --tag "${TAG_DATE}")
          if [ "${IS_TAG:-0}" = "1" ] && [ -n "${TAG_SEM:-}" ]; then
            BUILD_CMD+=(--tag "${TAG_SEM}" --tag "${TAG_SEM_DATE}")
          fi
          BUILD_CMD+=(hello_world)
          echo "Running: ${BUILD_CMD[*]}"
          "${BUILD_CMD[@]}"
        env:
          DOCKER_BUILDKIT: 1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f hello_world/requirements.txt ]; then pip install -r hello_world/requirements.txt; fi

      - name: Run hello script (background + smoke test)
        working-directory: hello_world
        run: |
          # start server in background, smoke-test it, then stop it so CI step doesn't hang
          python hello.py &
          SERVER_PID=$!
          # give server a moment to start
          sleep 2
          # try connecting a few times in case server needs more time
          curl --retry 5 --retry-delay 1 --fail http://127.0.0.1:8000/
          # cleanup background server (best-effort)
          kill $SERVER_PID || true

  deploy-production:
    name: deploy-production (main branch)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "Droplet User staging ${{ secrets.DROPLET_USER }}"
            # install docker if missing
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              curl -fsSL https://get.docker.com | sh
            fi

            # install compose plugin if missing
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            APP_DIR=/opt/ForDigitaOcean
            if [ -d "$APP_DIR" ]; then
              cd "$APP_DIR"
              git fetch --all
              git reset --hard origin/main
            else
              git clone https://github.com/Gubbya/ForDigitaOcean.git "$APP_DIR"
              cd "$APP_DIR"
            fi

            # login to GHCR if provided
            if [ -n "${GHCR_PAT}" ]; then
              echo "${GHCR_PAT}" | docker login ghcr.io -u Gubbya --password-stdin
            fi

            docker compose pull || true
            docker compose up -d --build

            # wait for the 'hello' service to become healthy (timeout configurable)
            SERVICE_NAME=hello
            TIMEOUT=60
            SLEEP=2
            RETRIES=$((TIMEOUT / SLEEP))
            CONTAINER_ID=$(docker compose ps -q "$SERVICE_NAME")
            if [ -n "$CONTAINER_ID" ]; then
              echo "Waiting up to ${TIMEOUT}s for $SERVICE_NAME to become healthy..."
              HEALTH=""
              for i in $(seq 1 $RETRIES); do
                HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}no-health{{end}}' "$CONTAINER_ID" 2>/dev/null || true)
                echo "Attempt $i/$RETRIES - health: ${HEALTH}"
                if [ "$HEALTH" = "healthy" ]; then
                  echo "$SERVICE_NAME is healthy"
                  break
                fi
                sleep $SLEEP
              done
              if [ "$HEALTH" != "healthy" ]; then
                echo "ERROR: $SERVICE_NAME failed to become healthy within ${TIMEOUT}s. Current health: ${HEALTH}"
                docker logs --tail 200 "$CONTAINER_ID" || true
                exit 1
              fi
            fi

            # TLS/certbot steps removed: nginx and certbot services are not used in this deployment
            echo "Skipping certbot/nginx steps; deploying app-only stack"
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    steps:
      - name: Deploy to Staging Droplet via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST_STAGING }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "Droplet User staging ${{ secrets.DROPLET_USER }}"
            # install docker if missing
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              curl -fsSL https://get.docker.com | sh
            fi

            # install compose plugin if missing
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            APP_DIR=/opt/ForDigitaOcean
            if [ -d "$APP_DIR" ]; then
              cd "$APP_DIR"
              git fetch --all
              # checkout the staging branch if present
              git checkout -f staging || true
              git reset --hard origin/staging || true
            else
              git clone https://github.com/Gubbya/ForDigitaOcean.git "$APP_DIR"
              cd "$APP_DIR"
              git checkout -f staging || true
            fi

            # login to GHCR if provided
            if [ -n "${GHCR_PAT}" ]; then
              echo "${GHCR_PAT}" | docker login ghcr.io -u Gubbya --password-stdin
            fi

            docker compose pull || true
            docker compose up -d --build

            # wait for the 'hello' service to become healthy (timeout configurable)
            SERVICE_NAME=hello
            TIMEOUT=60
            SLEEP=2
            RETRIES=$((TIMEOUT / SLEEP))
            CONTAINER_ID=$(docker compose ps -q "$SERVICE_NAME")
            if [ -n "$CONTAINER_ID" ]; then
              echo "Waiting up to ${TIMEOUT}s for $SERVICE_NAME to become healthy..."
              HEALTH=""
              for i in $(seq 1 $RETRIES); do
                HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}no-health{{end}}' "$CONTAINER_ID" 2>/dev/null || true)
                echo "Attempt $i/$RETRIES - health: ${HEALTH}"
                if [ "$HEALTH" = "healthy" ]; then
                  echo "$SERVICE_NAME is healthy"
                  break
                fi
                sleep $SLEEP
              done
              if [ "$HEALTH" != "healthy" ]; then
                echo "ERROR: $SERVICE_NAME failed to become healthy within ${TIMEOUT}s. Current health: ${HEALTH}"
                docker logs --tail 200 "$CONTAINER_ID" || true
                exit 1
              fi
            fi

            # TLS/certbot steps removed: nginx and certbot services are not used
            echo "Skipping certbot/nginx steps; deploying app-only stack"
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}

  debug:
    runs-on: ubuntu-latest
    steps:
      - name: üìã Show last 50 lines of runner profile and shell rc
        run: |
          # show runner profile files if present (best-effort)
          if [ -f ~/.profile ]; then echo "=== ~/.profile (last 50 lines) ==="; tail -n 50 ~/.profile || true; fi
          if [ -f ~/.bashrc ]; then echo "=== ~/.bashrc (last 50 lines) ==="; tail -n 50 ~/.bashrc || true; fi

      - name: üì∫ Show recent GitHub Actions workflow runs (via API)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # the runner may not have the gh CLI installed; use the Actions API as a fallback
          echo "Listing recent workflow runs (raw JSON, truncated)"
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=5" | sed -n '1,200p' || true

      - name: ‚ÑπÔ∏è Show docker status locally
        run: |
          docker --version || true
          docker ps -a || true
